<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Transformer Path Visualizer</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
	<link rel="stylesheet" href="../static/css/style.css">
	<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
</head>
<body>
	<div id="app-container">
		<div id="settings-panel">
			<div id="settings-content" class="d-flex flex-column h-100">
				<div class="p-3 border-bottom">
					<h5 class="mb-0">Settings</h5>
				</div>
				<div class="p-3 flex-grow-1">
					<div class="mb-4">
						<label for="num-paths-slider" class="form-label fw-bold">Number of Paths: <span id="num-paths-value" class="badge bg-primary">100</span></label>
						<input type="range" class="form-range" min="1" max="100" value="100" id="num-paths-slider" data-bs-toggle="tooltip" title="Controls the number of top paths to calculate and display. The maximum value is updated based on the number of paths found.">
					</div>
					<div class="mb-4">
						<label for="color-scheme-select" class="form-label fw-bold">Color Scheme</label>
						<select id="color-scheme-select" class="form-select" data-bs-toggle="tooltip" title="Changes the edge coloring logic in the main graph.">
							<option value="input_position" selected>Input Position</option>
							<option value="path_weight">Path Weight</option>
							<option value="path_index">Path Index</option>
						</select>
					</div>
					<div class="form-check form-switch mb-4">
						<input class="form-check-input" type="checkbox" role="switch" id="divide-heads-switch" checked data-bs-toggle="tooltip" title="If checked, shows individual attention heads as separate nodes in the graph.">
						<label class="form-check-label" for="divide-heads-switch">Show Individual Heads</label>
					</div>
					<div class="form-check form-switch mb-4">
						<input class="form-check-input" type="checkbox" role="switch" id="show-secondary-plot-switch" data-bs-toggle="tooltip" title="Toggles the visibility of the path details panel.">
						<label class="form-check-label" for="show-secondary-plot-switch">Show Path Details</label>
					</div>
					<div class="form-check form-switch mb-4">
						<input class="form-check-input" type="checkbox" role="switch" id="edge-priority-switch" data-bs-toggle="tooltip" title="If enabled, edges are prioritized based on their weights.">
						<label class="form-check-label" for="edge-priority-switch">Prioritize Relevant Edges</label>
					</div>
				</div>
			</div>
			<div id="resize-handle"></div>
		</div>

		<div id="main-wrapper">
			<header class="d-flex justify-content-between align-items-center p-3 border-bottom shadow-sm flex-shrink-0">
				<div class="d-flex align-items-center">
					<button id="settings-toggle" class="btn btn-outline-secondary me-3" type="button" data-bs-toggle="tooltip" data-bs-placement="right" title="Toggle Settings">
						<i class="bi bi-gear-fill"></i>
					</button>
					<h4 class="mb-0">Transformer Path Visualizer</h4>
				</div>
				<div class="ms-auto d-flex align-items-center">
					<div class="btn-group" role="group" aria-label="top-right-actions">
						<button id="theme-toggle" class="btn btn-outline-secondary" title="Change Theme">
							<i class="bi bi-sun-fill"></i>
						</button>
						<button id="download-button" class="btn btn-outline-secondary" data-bs-toggle="tooltip" data-bs-placement="right" title="Download The Paths">
							<i class="bi bi-download"></i>
						</button>
					</div>
				</div>
			</header>

			<main>

				<div id="input-row" class="row g-3 align-items-end mb-2">
					<div class="d-flex justify-content-end mb-2">
						<div class="form-check form-switch">
							<input class="form-check-input" type="checkbox" role="switch" id="input-mode-switch">
							<label class="form-check-label" for="input-mode-switch">Use Custom Prompt</label>
						</div>
					</div>                    
                    <div class="col">
                        <div id="model-task-view" class="row g-3">
                            <div class="col-md">
                                <label for="model-select" class="form-label small">Model</label>
                                <select id="model-select" class="form-select form-select-lg" data-bs-toggle="tooltip" title="Select a model to visualize.">
                                    <option selected>gpt2-small</option>
                                    <option>qwen2.5-0.5B</option>
                                </select>
                            </div>
                            <div class="col-md">
                                <label for="task-select" class="form-label small">Task</label>
                                <select id="task-select" class="form-select form-select-lg" data-bs-toggle="tooltip" title="Select a task circuit to visualize.">
                                    <option selected>Indirect Object Identification</option>
                                    <option>Multiple Choice Question Answer</option>
                                </select>
                            </div>
							<div class="col-md">
                                <label for="mode-select" class="form-label small">Metric</label>
                                <select id="mode-select" class="form-select form-select-lg" data-bs-toggle="tooltip" title="Select the evaluation metric.">
                                    <option selected>Probability</option>
                                    <option>Logit</option>
									<option>KL divergence</option>
                                </select>
                            </div>
                        </div>

                        <div id="prompt-target-view" class="row g-3" style="display: none;">
                            <div class="col-md-2">
                                <label for="model-select-run" class="form-label small">Model</label>
                                <select id="model-select-run" class="form-select form-select-lg" data-bs-toggle="tooltip" title="Select a model to visualize.">
                                    <option selected>gpt2-small</option>
                                    <option>qwen2.5-0.5B</option>
                                </select>
                            </div>
                            <div class="col">
                                <label for="prompt-input" class="form-label small">Input Text</label>
                                <input type="text" class="form-control form-control-lg" id="prompt-input" value="When John and Mary went to the shops, John gave the bag to" data-bs-toggle="tooltip" title="Enter the input sequence for the model.">
                            </div>
                            <div class="col-md-3">
                                <label for="target-token-input" class="form-label small">Target Token</label>
                                <input type="text" class="form-control form-control-lg" id="target-token-input" value=" Mary" data-bs-toggle="tooltip" title="Enter the target token you expect the model to predict. Remember that often tokens starts with a blanck space. If left blanck no token will be targeted and KL-Divergence will be used">
                            </div>
                        </div>
                    </div>

                    <div class="col-auto">
                        <button id="run-button" class="btn btn-primary btn-lg">Visualize Circuit</button>
                    </div>
                </div>

				<div id="loader" class="text-center my-5" style="display: none;">
					<div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
					<p class="mt-3 fs-5">Processing visualization...</p>
				</div>

				<div id="plot-area">
					<div id="primary-plot-container">
						<div id="primary-plot" class="plot-container"></div>
					</div>
					<div id="secondary-plot-wrapper" style="display: none;">
						<div class="card h-100">
							<div class="card-body p-2 d-flex flex-column">
								<div id="secondary-plot-content" class="flex-grow-1 d-flex flex-column">
									<div class="card-header">
										<div id="path-slider-container" class="mb-2">
											</div>
										<h6 class="mb-0 text-center border-top pt-2">Path Details</h6>
									</div>
									<div id="secondary-plot" class="plot-container flex-grow-1"></div>
									<div id="path-details-info" class="p-2 small border-top"></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>